{"data":{"css":".deletebotbutton{\n  float:right;\n}\n\n.addgrp {\n  position:absolute;\n  top:200px;\n  left:300px;\n}\n\n.addlibx {\n  position:absolute;\n  top:267px;\n  left:300px;\n}\n\n.addctl {\n  position:absolute;\n  top:334px;\n  left:300px;\n}","data":[],"name":"bot","js":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nme.ready = function(){\n  componentHandler.upgradeAllRegistered();\n  \n  var data = $(ME).data('control');\n  $(ME).find('#dbotname').val(data.name).parent()[0].MaterialTextfield.checkDirty();\n  $(ME).find('#dbottoken').val(data.token).parent()[0].MaterialTextfield.checkDirty();\n  \n  setSelect('groupselect', data.group);\n  setSelect('libselwrap', data.lib);\n  setSelect('ctlselwrap', data.ctl);\n};\n\nfunction setSelect(claz, val){\n  var wrap = $(ME).find('.'+claz);\n  var el = wrap.find('select');\n  if (el[0]) {\n    el.val(val).parent()[0].MaterialSelectfield.checkDirty();\n    el.change();\n  }\n  else setTimeout(function(){ setSelect(claz, val); }, 100);\n}\n\n$(ME).find('.savebotbutton').click(function(){\n  var data = $(ME).data('control');\n  if (!data.id) data.id = guid();\n  data.name = $(ME).find('#dbotname').val();\n  data.token = $(ME).find('#dbottoken').val();\n  data.group = $(ME).find('.groupselect').find('select').val();\n  data.lib = $(ME).find('.libselwrap').find('select').val();\n  data.ctl = $(ME).find('.ctlselwrap').find('select').val();\n  data.cb(data);\n  $(ME).empty();\n});\n\n$(ME).find('.editbotbutton').click(function(){\n  var data = $(ME).data('control');\n  window.location.href='../metabot/editcontrol.html?tab=api&db='+data.lib+'&id='+data.ctl;\n});\n\n$(ME).find('.deletebotbutton').click(function(){\n  document.body.api.delete($(ME).data('control').id);\n  document.body.api.save();\n  $(ME).empty();\n});\n\nvar validchars = 'abcdefghijklmnopqrstuvwxyz_0123456789';\n\nfunction validateString(val){\n  if (val.length == 0) return false;\n  var i = val.length;\n  while (i-->0) if (validchars.indexOf(val.charAt(i)) == -1) return false;\n  return true;\n}\n\n$(ME).find('.addgrp').click(function(){\n  var data = {\n    title:'New Group',\n    text:'New group name',\n    subtext:'lowercase letters, numbers, and underscores only.',\n    cancel:'cancel',\n    ok:'create',\n    validate:validateString,\n    cb: function(val){\n      var el = '<option value=\"'+val+'\">'+val+'<\/option>';\n      var sel = $(ME).find('.groupselect').find('select');\n      sel.append(el);\n      sel.val(val);\n      sel.parent()[0].MaterialSelectfield.checkDirty();\n    }\n  };\n  installControl($(ME).find('.dialogdiv')[0], 'metabot', 'promptdialog', function(){}, data);\n});\n\n$(ME).find('.addlibx').click(function(){\n  var data = {\n    title:'New Library',\n    text:'New library name',\n    subtext:'lowercase letters, numbers, and underscores only.',\n    cancel:'cancel',\n    ok:'create',\n    validate:validateString,\n    cb: function(val){\n      json('../botmanager/newdb', 'db='+encodeURIComponent(val)+'&readers='+encodeURIComponent(JSON.stringify([\"anonymous\"])), function(result){\n        json('../botmanager/write', 'id=tasklists&data=%7B%7D&db='+encodeURIComponent(val), function(result){\n          installControl($(ME).find('.dccs')[0], 'metabot', 'controlselect', function(){\n            setTimeout(function(){\n              $(ME).find('.libselwrap').find('select').val(val).parent()[0].MaterialSelectfield.checkDirty();\n              $(ME).find('.libselwrap').find('select').change();\n            }, 500);\n          }, {});\n        });\n      });\n    }\n  };\n  installControl($(ME).find('.dialogdiv')[0], 'metabot', 'promptdialog', function(){}, data);\n});\n\n$(ME).find('.addctl').click(function(){\n  var data = {\n    title:'New Control',\n    text:'New Control name',\n    subtext:'lowercase letters, numbers, and underscores only.',\n    cancel:'cancel',\n    ok:'create',\n    validate:validateString,\n    cb: function(val){\n      var ctl = { name: val };\n      var db = $(ME).find('.libselwrap').find('select').val();\n      json('../botmanager/write', 'db='+encodeURIComponent(db)+'&data='+encodeURIComponent(JSON.stringify(ctl)), function(result){\n        if (result.status != 'ok') alert(result.msg);\n        else {\n          ctl.id = result.id;\n          json('../botmanager/read', 'db='+db+'&id=controls', function(result){\n            me.controls = result.data;\n            if (!me.controls) me.controls = {};\n            if (!me.controls.list) me.controls.list = [];\n            me.controls.list.push(ctl);\n            me.controls.list.sort(function(a,b) {return (a.name.toLowerCase() > b.name.toLowerCase()) ? 1 : ((b.name.toLowerCase() > a.name.toLowerCase()) ? -1 : 0);} ); \n            saveControls(db, function(){\n              $(ME).find('.libselwrap').find('select').change();\n              setTimeout(function(){\n                $(ME).find('.ctlselwrap').find('select').val(ctl.id).parent()[0].MaterialSelectfield.checkDirty();\n              }, 500);\n            });\n          });\n        }\n      });\n    }\n  };\n  installControl($(ME).find('.dialogdiv')[0], 'metabot', 'promptdialog', function(){}, data);\n});\n    \nfunction saveControls(db, cb){\n  var ctl = me.controls;\n  var readers = [ \"anonymous\" ];\n  json('../botmanager/write', 'db='+encodeURIComponent(db)+'&id=controls&readers='+encodeURIComponent(JSON.stringify(readers))+'&data='+encodeURIComponent(JSON.stringify(ctl)), function(result){\n    if (result.status != 'ok') alert(result.msg);\n    else cb();\n  });\n}\n\n\n","groups":"anonymous","ctl":"rxzxuw164b417fb24g9d","html":"<form action=\"#\">\n  <div class=\"mdl-textfield mdl-js-textfield\">\n    <input class=\"mdl-textfield__input\" type=\"text\" id=\"dbotname\" value='My New Bot'>\n    <label class=\"mdl-textfield__label\" for=\"dbotname\">Name<\/label>\n  <\/div>\n<\/form>\n\n<form action=\"#\">\n  <div class=\"mdl-textfield mdl-js-textfield\">\n    <input class=\"mdl-textfield__input\" type=\"text\" id=\"dbottoken\">\n    <label class=\"mdl-textfield__label\" for=\"dbottoken\">Token<\/label>\n  <\/div>\n<\/form>\n\n<div class='data-control dcgs' data-control='securitybot:groupselect'><\/div>\n<div class='data-control dccs' data-control='metabot:controlselect'><\/div>\n\n<button class=\"mdl-button mdl-js-button mdl-button--icon mdl-button--colored addgrp\">\n  <i class=\"material-icons\">add<\/i>\n<\/button>\n\n<button class=\"mdl-button mdl-js-button mdl-button--icon mdl-button--colored addlibx\">\n  <i class=\"material-icons\">add<\/i>\n<\/button>\n\n<button class=\"mdl-button mdl-js-button mdl-button--icon mdl-button--colored addctl\">\n  <i class=\"material-icons\">add<\/i>\n<\/button>\n\n<button class=\"mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored savebotbutton\">\n  Save\n<\/button>\n<button class=\"mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent editbotbutton\">\n  Edit\n<\/button>\n<button class=\"mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent deletebotbutton\">\n  Delete\n<\/button>\n<div class='dialogdiv'><\/div>","db":"discord","desc":""},"readers":["anonymous"],"id":"rxzxuw164b417fb24g9d","sessionid":"jvgvwg16b7a4d277bt3","time":1618944511362,"addr":"/0:0:0:0:0:0:0:1:35764","username":"admin"}